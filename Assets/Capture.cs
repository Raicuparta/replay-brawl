using UnityEngine;
using UnityStandardAssets._2D;
using System.Collections.Generic;

public class Capture : MonoBehaviour {
    public bool Recording = false;
    public bool Replaying = false;

    int TickCount = 0;

    Rigidbody2D Body;
    PlatformerCharacter2D Player;
    Platformer2DUserControl PlayerControl;

    List<Step> Steps;

    [System.Serializable]
    public class Step {
        public Vector3 Position;
        public Step(Vector3 position) {
            Position = position;
        }
        public override string ToString() {
            return VectorToString(Position);
        }
    }

    // Use this for initialization
    void Start() {
        Steps = new List<Step>();
        Body = GetComponent<Rigidbody2D>();
        Player = GetComponent<PlatformerCharacter2D>();
        PlayerControl = GetComponent<Platformer2DUserControl>();
        ReadFromString("4,0|4,-0.01569599|4,-0.047088|4,-0.09417599|4,-0.15696|4,-0.23544|4,-0.329616|4,-0.439488|4,-0.565056|4,-0.70632|4,-0.6882211|4,-0.6789545|4,-0.67701|4,-0.6754544|4,-0.67421|4,-0.6732144|4,-0.6724179|4,-0.6717808|4,-0.671271|4,-0.6708633|4,-0.6705371|4,-0.670276|4,-0.6700673|4,-0.6699002|4,-0.6697666|4,-0.6696597|4,-0.6695742|4,-0.6695058|4,-0.6694511|4,-0.6694072|4,-0.6693722|4,-0.6693442|4,-0.6693218|4,-0.6693038|4,-0.6692895|4,-0.6692895|4,-0.6692895|4,-0.6692895|4,-0.6692895|4,-0.6692895|4,-0.6692895|4,-0.6692895|4,-0.6692895|4,-0.6692895|4,-0.6692895|4,-0.6692895|4,-0.6692895|4,-0.6692895|4,-0.6692895|4.025722,-0.6692781|4.063443,-0.6692689|4.125165,-0.6692615|4.216887,-0.6692556|4.330608,-0.6692509|4.45833,-0.6692472|4.596051,-0.6692442|4.743773,-0.6692418|4.923494,-0.6692399|5.103216,-0.6692383|5.292938,-0.6692371|5.48666,-0.6692361|5.680381,-0.6692353|5.874103,-0.6692347|6.067825,-0.6692342|6.261547,-0.6692338|6.455268,-0.6692334|6.64299,-0.6692332|6.814712,-0.669233|6.976433,-0.6692328|7.132155,-0.6692327|7.259877,-0.6692325|7.377598,-0.6692325|7.47732,-0.6692324|7.431334,-0.6692324|7.401613,-0.6692324|7.323891,-0.6692323|7.23217,-0.6692323|7.126448,-0.6692323|7.018726,-0.6692323|6.909005,-0.6692323|6.799283,-0.6692323|6.689561,-0.6692323|6.57984,-0.6692323|6.470118,-0.6692323|6.360396,-0.6692323|6.250675,-0.6692323|6.140953,-0.6692323|6.031231,-0.6692323|5.92151,-0.6692323|5.811788,-0.6692323|5.702066,-0.6692323|5.592345,-0.6692323|5.482623,-0.6692323|5.372901,-0.6692323|5.26318,-0.6692323|5.153458,-0.6692323|5.043736,-0.6692323|4.934015,-0.6692323|4.824293,-0.6692323|4.714571,-0.6692323|4.60485,-0.6692323|4.495128,-0.6692323|4.385406,-0.6692323|4.275685,-0.6692323|4.165963,-0.6692323|4.056242,-0.6692323|3.94652,-0.6692323|3.836798,-0.6692323|3.727077,-0.6692323|3.617355,-0.6692323|3.507633,-0.6692323|3.397912,-0.6692323|3.28819,-0.6692323|3.178468,-0.6692323|3.068747,-0.6692323|2.959025,-0.6692323|2.849303,-0.6692323|2.739582,-0.6692323|2.62986,-0.6692323|2.520138,-0.6692323|2.410417,-0.6692323|2.300695,-0.6692323|2.190973,-0.6692323|2.081252,-0.6692323|1.97153,-0.6692323|1.861809,-0.6692323|1.752087,-0.6692323|1.642365,-0.6692323|1.642365,-0.6692323|1.642365,-0.6692323|1.642365,-0.6692323|1.642365,-0.6692323|1.642365,-0.6692323|1.642365,-0.6692323|1.642365,-0.6692323|1.642365,-0.6692323|1.642365,-0.6692323|1.642365,-0.6692323|1.642365,-0.6692323|1.642365,-0.6692323|1.642365,-0.6692323|1.642365,-0.6692323|1.642365,-0.6692323|1.642365,-0.6692323|1.642365,-0.6692323|1.642365,-0.6692323|1.642365,-0.6692323|1.642365,-0.6692323|1.642365,-0.6692323|1.642365,-0.6692323|1.642365,-0.6692323|1.642365,-0.6692323|1.642365,-0.6692323|1.642365,-0.6692323|1.642365,-0.6692323|1.642365,-0.6692323|1.642365,-0.6692323|1.642365,-0.6692323|1.642365,-0.6692323|1.642365,-0.6692323|1.642365,-0.6692323|1.642365,-0.6692323|1.642365,-0.6692323|1.642365,-0.6692323|1.642365,-0.6692323|1.642365,-0.6692323|1.642365,-0.6692323|1.642365,-0.6692323|1.642365,-0.6692323|1.642365,-0.6692323|1.642365,-0.6692323|1.642365,-0.6692323|1.642365,-0.6692323|1.642365,-0.6692323|1.604644,-0.6692323|1.566922,-0.6692323|1.499201,-0.6692323|1.405479,-0.6692323|1.267757,-0.6692323|1.082036,-0.6692323|0.8923142,-0.6692323|0.7025926,-0.6692323|0.512871,-0.6692323|0.3231494,-0.6692323|0.1334278,-0.6692323|-0.05629376,-0.6692323|-0.2460154,-0.6692323|-0.1688766,-0.6692323|-0.1510131,-0.6692323|-0.1487284,-0.6692323|-0.1472661,-0.6692323|-0.1463303,-0.6692323|-0.1457314,-0.6692323|-0.1453481,-0.6692323|-0.1451028,-0.6692323|-0.1449458,-0.6692323|-0.1448453,-0.6692323|-0.144781,-0.6692323|-0.1447398,-0.6692323|-0.1447135,-0.6692323|-0.1446966,-0.6692323|-0.1446858,-0.6692323|-0.1446789,-0.6692323|-0.1446745,-0.6692323|-0.1446716,-0.6692323|-0.1446699,-0.6692323|-0.1446687,-0.6692323|-0.144668,-0.6692323|-0.1446675,-0.6692323|-0.1446672,-0.6692323|-0.144667,-0.6692323|-0.1446669,-0.6692323|-0.1446669,-0.6692323|-0.1446669,-0.6692323|-0.1446668,-0.3649283|-0.1446667,-0.07632032|-0.1446667,0.1965917|-0.1446667,0.4538077|-0.0590702,0.6698325|-0.0590702,0.8759755|-0.0590702,1.066423|-0.0590702,1.241174|-0.0590702,1.400229|-0.0590702,1.543588|-0.0590702,1.671251|-0.0590702,1.783218|-0.0590702,1.879489|-0.0590702,1.960064|-0.0590702,2.024944|-0.0590702,2.074127|-0.0770702,2.107614|-0.1830702,2.125405|-0.3190702,2.1275|-0.5010702,2.113899|-0.7010702,2.084602|-0.9010702,2.039609|-1.10107,1.978921|-1.30107,1.902536|-1.29789,1.810455|-1.295855,1.702678|-1.294552,1.579205|-1.294552,1.440036|-1.294552,1.440036|-1.294552,1.440036|-1.294552,1.440036|-1.294552,1.440036|-1.294552,1.440036|-1.294552,1.440036|-1.294552,1.440036|-1.294552,1.440036|-1.294552,1.440036|-1.294552,1.440036|-1.294552,1.440036|-1.294552,1.440036|-1.294552,1.440036|-1.294552,1.440036|-1.294552,1.440036|-1.294552,1.440036|-1.294552,1.440036|-1.294552,1.440036|-1.294552,1.440036|-1.294552,1.440036|-1.294552,1.440036|-1.294552,1.440036|-1.294552,1.440036|-1.294552,1.440036|-1.294552,1.440036|-1.294552,1.440036|-1.294552,1.440036|-1.294552,1.440036|-1.294552,1.440036|-1.294552,1.440036|-1.294552,1.440036|-1.294552,1.440036|-1.294552,1.440036|-1.294552,1.440036|-1.294552,1.440036|-1.294552,1.440036|-1.294552,1.440036|-1.294552,1.440036|-1.294552,1.440036|-1.294552,1.440036|-1.294552,1.440036|-1.294552,1.440036|-1.294552,1.440036|-1.294552,1.440036|-1.294552,1.440036|-1.294552,1.440036|-1.294552,1.440036|-1.294552,1.440036|-1.294552,1.440036|-1.294552,1.440036|-1.294552,1.440036|-1.294552,1.440036|-1.294552,1.440036|-1.294552,1.440036|-1.294552,1.440036|-1.294552,1.440036|-1.294552,1.440036|-1.294552,1.440036|-1.270831,1.440036|-1.221109,1.440036|-1.155387,1.440036|-1.087666,1.440036|-1.017944,1.440036|-1.017944,1.440036|-1.017944,1.440036|-1.017944,1.440036|-1.017944,1.440036|-1.017944,1.440036|-1.017944,1.440036|-1.017944,1.440036|-1.017944,1.440036|-1.017944,1.440036|-1.017944,1.440036|-1.017944,1.440036|-1.017944,1.440036|-1.017944,1.440036|-1.017944,1.440036|-1.017944,1.440036|-1.017944,1.440036|-1.017944,1.440036|-1.017944,1.440036|-1.017944,1.440036|-1.017944,1.440036|-1.017944,1.440036|-1.017944,1.440036|-1.017944,1.440036|-1.017944,1.440036|-1.017944,1.440036|-1.017944,1.440036|-1.017944,1.440036|-1.017944,1.440036|-1.017944,1.440036|-1.017944,1.440036|-1.017944,1.440036|-1.017944,1.440036|-1.017944,1.440036|-1.017944,1.440036|-1.017944,1.440036|-1.017944,1.440036|-1.017944,1.440036|-1.017944,1.440036|-1.017944,1.440036|-1.017944,1.440036|-1.017944,1.440036|-1.017944,1.440036|-1.017944,1.440036|-1.017944,1.440036|-0.9942225,1.440036|-0.9705009,1.440036|-0.9467794,1.440036|-0.9467794,1.440036|-0.9467794,1.440036|-0.9467794,1.440036|-0.9467794,1.440036|-0.9467794,1.440036|-0.9467794,1.440036|-0.9467794,1.440036|-0.9467794,1.440036|-0.9467794,1.440036|-0.9467794,1.440036|-0.9467794,1.440036|-0.9467794,1.440036|-0.9467794,1.440036|-0.9467794,1.440036|-0.9467794,1.440036|-0.9467794,1.440036|-0.9467794,1.440036|-0.9467794,1.440036|-0.9467794,1.440036|-0.9467794,1.440036|-0.9467794,1.440036|-0.9467794,1.440036|-0.9467794,1.440036|-0.9467794,1.74434|-0.9467794,2.032948|-0.9467794,2.30586|-0.9467794,2.563076|-0.9467794,2.804596|-0.9467794,3.03042|-0.9467794,3.240548|-0.9467794,3.43498|-0.9467794,3.613716|-0.9467794,3.776757|-0.9467794,3.924101|-0.9467794,4.055749|-0.9467794,4.171701|-0.9467794,4.271957|-0.9467794,4.356517|-0.9467794,4.425381|-0.9467794,4.478549|-0.9467794,4.516021|-0.9467794,4.537797|-0.9467794,4.543877|-0.9467794,4.534261|-1.072779,4.510232|-1.220779,4.469224|-1.420779,4.41252|-1.62078,4.34012|-1.82078,4.252025|-1.754688,4.156202|-1.706688,4.036714|-1.658688,3.90153|-1.663217,3.946984|-1.664256,3.959095|-1.664373,3.960662|-1.66444,3.96167|-1.664476,3.962319|-1.66449,3.962738|-1.664492,3.963007|-1.664492,3.963215|-1.664492,3.963381|-1.664492,3.963514|-1.664492,3.96362|-1.664492,3.963705|-1.664492,3.963773|-1.664492,3.963827|-1.664492,3.963871|-1.664492,3.963906|-1.664492,3.963934|-1.664492,3.963956|-1.664492,3.963974|-1.664492,3.963988|-1.664492,3.964|-1.664492,3.964009|-1.664492,3.964016|-1.664492,3.964022|-1.664492,3.964026|-1.664492,3.964026|-1.664492,3.964026|-1.664492,3.964026|-1.664492,3.964026|-1.664492,3.964026|-1.664492,3.964026|-1.664492,3.964026|-1.664492,3.964026|-1.664492,3.964026|-1.664492,3.964026|-1.664492,3.964026|-1.664492,3.964026|-1.664492,3.964026|-1.664492,3.964026|-1.664492,3.964026|-1.664492,3.964026|-1.664492,3.964026|-1.664492,3.964026|-1.664492,3.964026|-1.664492,3.964026|-1.664492,3.964026|-1.664492,3.964026|-1.664492,3.964026|-1.664492,3.964026|-1.664492,3.964026|-1.664492,3.964026|-1.664492,3.964026|-1.664492,3.964026|-1.664492,3.964026|-1.664492,3.964026|-1.664492,3.964026|-1.664492,3.964026|-1.664492,3.964026|-1.664492,3.964026|-1.664492,3.964026|-1.664492,3.964026|-1.664492,3.964026|-1.664492,3.964026|-1.664492,3.964026|-1.664492,3.964026|-1.664492,3.964026|-1.664492,3.964026|-1.664492,3.964026|-1.664492,3.964026|-1.664492,3.964026|-1.664492,3.964026|-1.664492,3.964026|-1.664492,3.964026|-1.712213,3.964025|-1.773935,3.964029|-1.857657,3.964032|-1.977378,3.964035|-2.1411,3.964037|-2.334821,3.964038|-2.528543,3.96404|-2.722265,3.964041|-2.915986,3.964042|-3.109708,3.964042|-3.303429,3.964043|-3.303429,3.964043|-3.303429,3.964044|-3.303429,3.964044|-3.303429,3.964044|-3.303429,3.964044|-3.303429,3.964045|-3.303429,3.964045|-3.303429,3.964045|-3.303429,3.964045|-3.303429,3.964045|-3.303429,3.964045|-3.303429,3.964045|-3.303429,3.964045|-3.303429,3.964045|-3.303429,3.964045|-3.303429,3.964045|-3.303429,3.964045|-3.303429,3.964045|-3.303429,3.964045|-3.303429,3.964045|-3.303429,3.964045|-3.303429,3.964045|-3.303429,3.964045|-3.303429,3.964045|-3.303429,3.964045|-3.303429,3.964045|-3.303429,3.964045|-3.303429,3.964045|-3.303429,3.964045|-3.303429,3.964045|-3.303429,3.964045|-3.303429,3.964045|-3.303429,3.964045|-3.303429,3.964045|-3.303429,3.964045|-3.303429,3.964045|-3.303429,3.964045|-3.303429,3.964045|-3.303429,3.964045|-3.303429,3.964045|-3.303429,3.964045|-3.303429,3.964045|-3.303429,3.964045|-3.303429,3.964045|-3.303429,3.964045|-3.303429,3.964045|-3.303429,3.964045|-3.303429,3.964045|-3.303429,3.964045|-3.303429,3.964045|-3.303429,3.964045|-3.303429,3.964045|-3.303429,3.964045|-3.303429,3.964045|-3.303429,3.964045|-3.303429,3.964045|-3.303429,3.964045|-3.303429,3.964045|-3.303429,3.964045|-3.303429,3.964045|-3.303429,3.964045|-3.303429,3.964045|-3.303429,3.964045|-3.303429,3.964045|-3.303429,3.964045|-3.303429,3.964045|-3.303429,3.964045|-3.303429,3.964045|-3.303429,3.964045|-3.303429,3.964045|-3.303429,3.964045|-3.303429,3.964045|-3.303429,3.964045|-3.303429,3.964045|-3.303429,3.964045|-3.303429,3.964045|-3.303429,3.964045|-3.303429,3.964045|-3.303429,3.964045|-3.303429,3.964045|-3.303429,3.964045|-3.303429,3.964045|");
    }

    void FixedUpdate() {
        if (Recording || Replaying) TickCount++;

        if (Recording) {
            float attack = PlayerControl.GetAttack() ? 1 : 0;
            Vector3 position = new Vector3(Body.position.x, Body.position.y, attack);
            Steps.Add(new Step(position));
        }

        if (Replaying) {
            if (Recording) {
                Debug.Log(ToString());
                TickCount = 0;
                Recording = false;
            }
            if (TickCount >= Steps.Count) return;
            Body.position = ((Step)Steps[TickCount]).Position;
        }
    }

    public override string ToString() {
        string result = "";

        for (int i = 0; i < Steps.Count; i++)
            result += Steps[i] + "|";

        return result;
    }

    private static string VectorToString(Vector3 vector) {
        string result = vector.x + "," + vector.y;
        if (vector.z != 0) result += "," + vector.z;
        return result;
    }

    private Vector3 StringToVector(string s) {
        if (s.Length == 0) return Vector3.zero; // TODO deal with this

        Vector3 v = new Vector3();
        string[] values = s.Split(',');
        v.x = float.Parse(values[0]);
        v.y = float.Parse(values[1]);
        if (values.Length > 2)
            v.z = float.Parse(values[2]);
        else
            v.z = 0;
        return v;
    }

    public void ReadFromString(string data) {
        Steps.Clear();

        string[] steps = data.Split('|');

        for (int i = 0; i < steps.Length - 1; i++) {
            Vector3 position = StringToVector(steps[i]);
            Steps.Add(new Step(position));
        }
    }
}
